<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <title>商品管理</title>
        <link th:href="@{~/product/favicon.ico}" rel="shortcut icon">
        <link th:href="@{~/product/layui/css/layui.css}" rel="stylesheet" />
        <link th:href="@{~/product/css/common.css}" rel="stylesheet" />

        <script th:src="@{~/product/jquery/jquery-2.1.4.min.js}"></script>
        <script th:src="@{~/product/layui/layui.js}"></script>

        <style type="text/css">
            .taskImg {
                width: 28px;
                height: 28px;
                margin-right: 12px;
                display: inline-block;
            }
        </style>
    </head>

    <body>
        <div class="myPage">
            <div class="myTable">
                商品名：
                <div class="layui-inline">
                    <input type="text" autocomplete="off" class="layui-input" id="name" placeholder="请输入商品名称"/>
                </div>
                <button class="layui-btn" data-type="reload">搜索</button>

                <button class="layui-btn" data-type="add">新增</button>
            </div>
            <table class="layui-hide" id="productTable" lay-filter="product"></table>
        </div>

        <!-- 新增 -->
        <form id="addMask" class="layui-form" lay-filter="addMask" style="display: none; padding: 40px 0;">
            <div class="layui-form-item">
                <label class="layui-form-label">产品名称:</label>
                <div class="layui-inline" style="width: 380px;">
                    <input id="productName" type="text" placeholder="请填写产品名称" class="layui-input" lay-verify="required" />
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">产品图片:</label>
                <div class="layui-input-inline uploadBox" style="padding: 9px 0;">
                    <div class="taskImg">
                        <img src="" alt="" class="showImg">
                    </div>
                    <a id="uploadImg" href="javascript:void(0);" style="color: #1890FF;font-size: 14px;">上传图片</a>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">所属品牌:</label>
                <div class="layui-inline" style="width: 380px;">
                    <select id="brandId" lay-verify="required">
                        <option value="1" selected>华为</option>
                        <option value="2">小米</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品分类:</label>
                <div class="layui-input-inline" style="width: 120px;">
                    <select id="level1" lay-filter="level1">
                        <option value="0">一级分类</option>
                    </select>
                </div>
                <div class="layui-input-inline" style="width: 120px;">
                    <select id="level2" lay-filter="level2">
                        <option value="0">二级分类</option>
                    </select>
                </div>
                <div class="layui-input-inline" style="width: 120px;">
                    <select id="level3">
                        <option value="0">三级分类</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">产品描述:</label>
                <div class="layui-inline" style="width: 380px;">
                    <textarea id="description" placeholder="描述这款产品" class="layui-textarea"></textarea>
                </div>
            </div>
        </form>

        <!-- 表格操作按钮 -->
        <script type="text/html" id="optBar">
            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
            <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="skuEdit">编辑SKU</a>
        </script>
    </body>

    <script th:inline="javascript">
        var ctx = [[@{/}]];
        layui.use(['form', 'table', 'upload'], function() {
            var $ = layui.jquery,
                form = layui.form,
                table = layui.table,
                upload = layui.upload
                laypage = layui.laypage;

            // 表格数据载入
            console.log("ctx:", ctx);
            table.render({
                elem: '#productTable',
                url: 'listForPage',
                method: 'post', //方式
                page: true, //开启分页
                loading: true, //翻页加loading
                where: {

                },
                limit: 10, // 每页显示的条数
                limits: [10, 20, 50], // 每页条数的选择项
                id: 'tableData',
                cols: [ //表头
                    [{
                        title: '序号',
                        width: 60,
                        templet: function (d) {
                            return d.LAY_TABLE_INDEX + 1
                        }
                    }, {
                        field: 'name',
                        title: '商品名称',
                        width: 150
                    }, {
                        field: 'pic',
                        title: '商品图片',
                        width: 120
                    }, {
                        field: 'brandName',
                        title: '品牌',
                        width: 80
                    }, {
                        field: 'categoryId',
                        title: '分类id',
                        hide: true
                    }, {
                        field: 'categoryName',
                        title: '分类',
                        width: 80
                    }, {
                        field: 'description',
                        title: '描述',
                        width: 200
                    }, {
                        field: 'deleteStatus',
                        title: '状态',
                        width: 80
                    }, {
                        title: '操作',
                        toolbar: '#optBar',
                        width: 200
                    }]
                ]
            });

            var imgPath;
            var $ = layui.$, active = {
                reload: function () { // 查询
                    var name = $('#name').val();
                    console.log(name);
                    table.reload('tableData', {
                        where: {
                            "name": name
                        },
                        page: {
                            curr: 1
                        }
                    });
                }, add: function () { // 新增
                    layer.open({
                        type: 1,
                        area: '550px',
                        title: '新增商品',
                        btn: ['确定', '取消'],
                        shadeClose: true,
                        shade: 0,
                        maxmin: true,
                        content:$('#addMask'),
                        success: function(layero, index){
                            listByLevel();

                            // 清空
                            $('#uploadImg').remove()
                            $('.uploadBox').append('<a href="javascript:void(0);" id="uploadImg" style="color: #1890FF;font-size: 14px;">上传图片</a>')
                            // 选择图片
                            upload.render({
                                elem: '#uploadImg',
                                url: "uploadImg",
                                accept: 'images',
                                auto: true ,//选择文件后自动上传
                                multiple: false,
                                before: function(obj){ //obj参数包含的信息，跟 choose回调完全一致，可参见上文。

                                },
                                done: function(res){
                                    //上传完毕回调
                                    if(res.code == 0){
                                        //do something （比如将res返回的图片链接保存到表单的隐藏域）
                                        imgPath = res.data;
                                        $('.taskImg img').attr('src', "${callUrl}" + imgPath);
                                    }
                                },
                                error: function(){
                                    //请求异常回调
                                    layer.msg("出错啦，请稍后再试", {icon: 5});
                                }
                            });
                        },
                        yes:function(index, layero){
                            /*  $.ajaxSettings.async = false; */
                            var categoryId = 0;
                            var level3 = $('#level3').val();
                            var level2 = $('#level2').val();
                            var level1 = $('#level1').val();
                            if (level3 != 0) {
                                categoryId =  level3;
                            } else if (level2 != 0) {
                                categoryId =  level2;
                            } else {
                                categoryId =  level1;
                            }
                            $.ajax({
                                type: "POST",
                                url: 'add',
                                data: {
                                    name: $('#productName').val(),
                                    pic: imgPath,
                                    brandId: $('#brandId').val(),
                                    categoryId: categoryId,
                                    description: $('#description').val()
                                },
                                dataType: "JSON",
                                success: function(data){
                                    console.log(data);
                                    if (data.code == 0) {
                                        layer.close(index);//关闭弹出层
                                        $("#addMask")[0].reset()//重置form
                                        table.reload('tableData',{//重载表格
                                            page:{
                                                curr:1
                                            }
                                        })
                                        layer.alert('新增成功', {icon:1, title:'提示'}, function(i){
                                            layer.close(i);
                                        })
                                    } else {
                                        layer.alert('新增失败', {icon:2, title:'提示'}, function(i){
                                            layer.close(i);
                                        })
                                    }
                                },
                                error:function(){
                                    layer.alert("本次操作失败，请重新操作！", {icon:5, title:'错误'});
                                    return false;
                                }
                            })
                        },
                        cancel: function(index, layero) {
                            $('#addMask')[0].reset();
                            layui.form.render();
                        }
                    });
                }
            }
            $('.myTable .layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });

            //监听行工具事件
            table.on('tool(product)', function(obj){
                var data = obj.data;
                console.log("ctx:", ctx);
                if(obj.event === 'del'){
                    layer.confirm('您确定要删除吗？', function(index){
                        console.log("index:" + index);
                        $.ajax({
                            type: "POST",
                            url: 'remove/' + data.id,
                            data: {},
                            dataType: "JSON",
                            success: function(data){
                                console.log(data);
                                if (data.code == 0) {
                                    layer.msg('删除成功', {icon: 1});
                                    table.reload('tableData', {
                                        where: {
                                            "name": $('#name').val()
                                        },
                                        page: {
                                            curr: 1
                                        }
                                    });
                                } else {
                                    layer.msg('删除失败', {icon: 2});
                                }
                            },
                            error:function(){
                                layer.alert("本次操作失败，请重新操作！", {icon:5, title:'错误'});
                                return false;
                            }
                        })
                        layer.close(index);
                    });
                } else if(obj.event === 'edit'){
                    layer.open({
                        type: 1,
                        area: '550px',
                        title: '编辑商品',
                        btn: ['确定', '取消'],
                        shadeClose: true,
                        shade: 0,
                        maxmin: true,
                        content:$('#addMask'),
                        success:function(index, layero){
                            $("#productName").val(data.name);
                            $("#productLogo").val(data.logo);
                        },
                        yes:function(index, layero){
                            /*  $.ajaxSettings.async = false; */
                            $.ajax({
                                type: "POST",
                                url: 'edit',
                                data: {
                                    id: data.id,
                                    name: $('#productName').val(),
                                    logo: $('#productLogo').val()
                                },
                                dataType: "JSON",
                                success: function(data){
                                    console.log(data);
                                    if (data.code == 0) {
                                        layer.close(index);//关闭弹出层
                                        $("#addMask")[0].reset()//重置form
                                        table.reload('tableData',{//重载表格
                                            page:{
                                                curr:1
                                            }
                                        })
                                        layer.alert('编辑成功', {icon:1, title:'提示'}, function(i){
                                            layer.close(i);
                                        })
                                    } else {
                                        layer.alert('编辑失败', {icon:2, title:'提示'}, function(i){
                                            layer.close(i);
                                        })
                                    }
                                },
                                error:function(){
                                    layer.alert("本次操作失败，请重新操作！", {icon:5, title:'错误'});
                                    return false;
                                }
                            })
                        }
                    });
                } else if(obj.event === 'skuEdit'){
                    console.log("SKU编辑");
                    location.href = "sku?categoryId=" + data.categoryId + "&productId=" + data.id;
                }
            });

            form.on('select(level1)', function(data){
                $("#level2").empty();
                $("#level2").append(new Option("二级分类", ""));
                $("#level3").empty();
                $("#level3").append(new Option("三级分类", ""));
                //data.value 得到被选中的值
                var parId = data.value;
                if (parId == "") {
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: ctx + 'category/listByLevel',
                    dataType: "JSON",
                    data: {
                        level: 2,
                        parId: parId
                    },
                    success: function(data){
                        console.log(data);
                        if (data.code == 0) {
                            $.each(data.data, function(index, item){
                                $("#level2").append(new Option(item.name, item.id));
                            });
                            layui.form.render("select");
                        } else {
                            layer.alert('二级分类列表加载失败', {icon:2, title:'提示'}, function(i){
                                layer.close(i);
                            })
                        }
                    },
                    error:function(){
                        layer.alert("本次操作失败，请重新操作！", {icon:5, title:'错误'});
                        return false;
                    }
                })

            });

            form.on('select(level2)', function(data){
                $("#level3").empty();
                $("#level3").append(new Option("三级分类", ""));
                //data.value 得到被选中的值
                var parId = data.value;
                if (parId == "") {
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: ctx + 'category/listByLevel',
                    dataType: "JSON",
                    data: {
                        level: 3,
                        parId: parId
                    },
                    success: function(data){
                        console.log(data);
                        if (data.code == 0) {
                            $.each(data.data, function(index, item){
                                $("#level3").append(new Option(item.name, item.id));
                            });
                            layui.form.render("select");
                        } else {
                            layer.alert('三级分类列表加载失败', {icon:2, title:'提示'}, function(i){
                                layer.close(i);
                            })
                        }
                    },
                    error:function(){
                        layer.alert("本次操作失败，请重新操作！", {icon:5, title:'错误'});
                        return false;
                    }
                })

            });

            //监听单元格编辑
            table.on('edit(skuTable)', function(obj){
                var value = obj.value //得到修改后的值
                    ,data = obj.data //得到所在行所有键值
                    ,field = obj.field; //得到字段
                layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
            });

        });

        // 加载级联分类下拉列表
        function listByLevel() {
            $.ajax({
                type: "POST",
                url: ctx + 'category/listByLevel',
                dataType: "JSON",
                async: false,
                data: {
                    level: 1,
                    parId: 0
                },
                success: function(data){
                    console.log(data);
                    if (data.code == 0) {
                        $("#level1").empty();
                        $("#level1").append(new Option("一级分类", ""));
                        $.each(data.data, function(index, item){
                            $("#level1").append(new Option(item.name, item.id));
                        });
                        layui.form.render("select");
                    } else {
                        layer.alert('一级分类列表加载失败', {icon:2, title:'提示'}, function(i){
                            layer.close(i);
                        })
                    }
                },
                error:function(){
                    layer.alert("本次操作失败，请重新操作！", {icon:5, title:'错误'});
                    return false;
                }
            })
        }
    </script>
</html>